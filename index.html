<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Master - Event Screen</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for the Time Up sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0d1117; /* Very dark background */
        }
        .container {
            width: 100%;
            max-width: 1400px;
            height: 90vh; /* Fixed height for better control */
            background-color: #1c1e27; /* Dark charcoal card */
            border-radius: 1.5rem;
            box-shadow: 0 0 40px rgba(79, 70, 229, 0.5); /* Glowing border effect */
            overflow: hidden;
            border: 2px solid #4f46e5;
        }
        /* Custom animations for the visuals */
        .visual-item {
            animation: pulse-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .time-up-message {
            animation: shake 0.5s ease-in-out infinite alternate;
        }
        @keyframes pulse-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
            from { transform: translateX(-5px); }
            to { transform: translateX(5px); }
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        /* For 16:9 aspect ratio placeholder */
        .aspect-video {
            aspect-ratio: 16 / 9;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <!-- Content will be rendered here by JavaScript -->
</div>

<script>
    // --- Configuration and Data ---
    const SECRET_PASSWORD = 'EVENTRA2025';
    const AUTOMATIC_TIME = 5; // Default time for automatic questions (Q1, Q2, Q3)
    
    // COORDINATORS with Roles and Titles
    const COORDS = [
        { name: "Mr. T. PITCHAIMANI", title: "Faculty Coordinator (AP/MATHS)" },
        { name: "Rohit SK", title: "President, Programming Club (CSE AIML)" },
        { name: "Sudharsan R", title: "Event Architect, Programming Club (CSE AIML)" }
    ];
    
    // --- ROUND 1 QUESTIONS: RAPID RECALL (No Password) ---
    const QUESTIONS_DATA_ROUND_1 = [
        { 
            id: 1, round: 1,
            title: "Puzzle 1: Circular Sequence", 
            type: "circles", isManual: false,
            prompt: "What color was the 5th circle? / How many Red circles were there? / List the colors in REVERSE order.",
            colors: ['#FF6347', '#4682B4', '#3CB371', '#FFD700', '#FF6347', '#9370DB', '#FFA500', '#2F4F4F'] // 8 colors
        },
        { 
            id: 2, round: 1,
            title: "Puzzle 2: The Merged Bottles", 
            type: "bottles", isManual: false,
            prompt: "Which color bottle was next to the Blue one? / List the TOP 3 colors.",
            colors: ['#8A2BE2', '#F08080', '#40E0D0', '#FF4500', '#0000CD'] // 5 colors
        },
        { 
            id: 3, round: 1,
            title: "Puzzle 3: Color and Shape Association", 
            type: "shapes", isManual: false,
            prompt: "What SHAPE was colored GREEN? / What COLOR was the TRIANGLE?",
            shapes: [
                { color: '#FF0000', shape: 'Square' },
                { color: '#0000FF', shape: 'Triangle' },
                { color: '#008000', shape: 'Star' },
                { color: '#FFFF00', shape: 'Circle' }
            ]
        },
        { 
            id: 4, round: 1,
            title: "Puzzle 4: Spot the Difference", 
            type: "diff", isManual: true, // Coordinator controlled
            prompt: "List the 5 differences between the two images.",
            diffs: [{ color: '#FF0000', text: '5 Differences' }, { color: '#008000', text: 'To Find' }]
        },
        { 
            id: 5, round: 1,
            title: "Puzzle 5: Sequence Gap", 
            type: "gap", isManual: true, // Coordinator controlled
            prompt: "What item came BEFORE the 'Phone'? / What came AFTER the 'Key'?",
            items: ['Apple', 'Book', 'Key', 'BLANK', 'Phone', 'Chair']
        }
    ];

    // --- ROUND 2 QUESTIONS: LOGIC & DEDUCTION (Password Protected) ---
    // NOTE: All Round 2 Puzzles are now set to isManual: true
    const QUESTIONS_DATA_ROUND_2 = [
        {
            id: 6, round: 2,
            title: "Puzzle 6: Object Recall (Visual Memory - Scene 1)",
            type: "object_recall", isManual: true, // Manual timing
            prompt: "Write down the names of the objects you saw in the image.",
        },
        {
            id: 7, round: 2,
            title: "Puzzle 7: Object Recall (Position & Detail - Scene 2)",
            type: "object_recall", isManual: true, // Manual timing
            prompt: "What color was the top-left object? / What object was in the center?",
        },
        {
            id: 8, round: 2,
            title: "Puzzle 8: Video Analysis (Coordinators Play Video)",
            type: "video", isManual: true, // Manual timing
            prompt: "Answer questions based on the video: What was the killer wearing? / What sound played after the clock struck 12?",
        },
        {
            id: 9, round: 2,
            title: "Puzzle 9: Find the __EVENTRA____ - Scenario A (Single Image)",
            type: "killer_scenario", isManual: true, // Manual timing
            prompt: "Based on the four visual clues, which suspect committed the crime?",
            panels: ['Clue 1: Footprints on Mud', 'Clue 2: Missing Button', 'Clue 3: Torn Note', 'Clue 4: Suspect Alibis'], 
        },
        {
            id: 10, round: 2,
            title: "Puzzle 10: Find the EVENTRA - Scenario B (Single Image)",
            type: "killer_scenario", isManual: true, // Manual timing
            prompt: "Identify the critical sequence of events that led to the solution.",
            panels: ['Clue 1: Broken Glass', 'Clue 2: Time of Day', 'Clue 3: Witness Account', 'Clue 4: The Weapon'],
        }
    ];

    // --- ROUND 3 QUESTIONS: FINAL CODEBREAKER (NEW, Password Protected) ---
    const QUESTIONS_DATA_ROUND_3 = [
        {
            id: 11, round: 3,
            title: "Puzzle 11: Logic Code Breaker",
            type: "code_breaker", isManual: true, 
            prompt: "What is the 5-digit key code? (The sequence of numbers represented by the colors and hints.)",
            code_parts: [
                { color: '#FF4500', hint: 'First Prime' },
                { color: '#DAA520', hint: 'Last Digit' },
                { color: '#8A2BE2', hint: 'Middle Square' },
                { color: '#00FA9A', hint: 'Two Times Two' },
                { color: '#4682B4', hint: 'Third Number' }
            ]
        },
        {
            id: 12, round: 3,
            title: "Puzzle 12: Reverse Deduction",
            type: "reverse_deduction", isManual: true, 
            prompt: "The objects were placed into the box one by one. If they must be removed in the reverse order of placement, what item was removed last?",
            items: ['Box', 'Pencil', 'Marble', 'Book', 'Key', 'Lock']
        }
    ];

    // --- State Management ---
    // Added 'selection' state for the new intermediate page
    let currentState = 'start'; // 'start', 'selection', 'password1', 'password2', 'password3', 'round1', 'round2', 'round3', 'end'
    let currentRound = 1;
    let currentQuestionIndex = 0;
    let timerInstance = null;
    let appEl;
    let synth;

    // --- Utility Functions ---

    function getCurrentQuestions() {
        if (currentRound === 1) return QUESTIONS_DATA_ROUND_1;
        if (currentRound === 2) return QUESTIONS_DATA_ROUND_2;
        if (currentRound === 3) return QUESTIONS_DATA_ROUND_3;
        return [];
    }

    function initTone() {
        // Initialize Tone.js components if not already done
        if (!synth) {
             Tone.start().then(() => {
                synth = new Tone.MembraneSynth().toDestination();
            }).catch(e => console.error("Tone.js failed to start:", e));
        }
    }

    function playTimeUp() {
        // Ensure synth is initialized before triggering sound
        if (synth) {
            synth.triggerAttackRelease("C3", "8n", Tone.now()); 
        } else {
            initTone(); // Try initializing again
        }
    }

    // --- View Rendering ---

    function renderStartScreen() {
        const coordsHtml = COORDS.map(coord => `
            <div class="text-center mx-6 p-4 rounded-lg bg-gray-800 shadow-xl border-t-4 border-indigo-500">
                <p class="text-2xl font-semibold text-gray-100">${coord.name}</p>
                <p class="text-lg font-medium text-indigo-400 mt-1">${coord.title}</p>
            </div>
        `).join('');
        
        appEl.innerHTML = `
            <div class="flex flex-col h-full justify-center items-center p-8 bg-gray-900">
                <h1 class="text-8xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500 mb-8 tracking-tighter">MIND MASTER</h1>
                <p class="text-3xl font-light text-gray-300 mb-16">The Ultimate Cognitive Challenge</p>
                
                <!-- SINGLE START BUTTON TO GO TO SELECTION PAGE -->
                <button onclick="changeState('selection')" 
                    class="btn-primary px-16 py-6 bg-indigo-600 text-white text-4xl font-extrabold rounded-xl shadow-2xl shadow-indigo-700/50 hover:bg-indigo-700 transition duration-300 transform hover:scale-110 uppercase tracking-widest border-4 border-indigo-400">
                    START EVENT
                </button>
                <!-- END SINGLE START BUTTON -->

                <div class="mt-24 text-center w-full">
                    <h2 class="text-3xl font-extrabold text-yellow-400 mb-6">Event Coordinators</h2>
                    <div class="flex justify-center space-x-8">${coordsHtml}</div>
                </div>
            </div>
        `;
    }

    // NEW Intermediate Page for Round Selection
    function renderRoundSelectionScreen() {
        appEl.innerHTML = `
            <div class="flex flex-col h-full justify-center items-center p-8 bg-gray-900">
                <h2 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 mb-20 tracking-tight">
                    SELECT EVENT ROUND
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-10 w-full max-w-6xl">
                    <button onclick="changeState('password1')" 
                        class="btn-primary flex flex-col items-center px-10 py-8 bg-green-600 text-white text-3xl font-bold rounded-xl shadow-2xl shadow-green-700/50 hover:bg-green-700 transition duration-300 transform hover:scale-105 uppercase tracking-wider border-4 border-green-300">
                        <span class="text-4xl mb-2">Round 1</span>
                        <span class="text-xl font-light opacity-80">(Rapid Recall)</span>
                    </button>
                    
                    <button onclick="changeState('password2')" 
                        class="btn-primary flex flex-col items-center px-10 py-8 bg-blue-600 text-white text-3xl font-bold rounded-xl shadow-2xl shadow-blue-700/50 hover:bg-blue-700 transition duration-300 transform hover:scale-105 uppercase tracking-wider border-4 border-blue-300">
                        <span class="text-4xl mb-2">Round 2</span>
                        <span class="text-xl font-light opacity-80">(Password Required)</span>
                    </button>
                    
                    <button onclick="changeState('password3')" 
                        class="btn-primary flex flex-col items-center px-10 py-8 bg-purple-600 text-white text-3xl font-bold rounded-xl shadow-2xl shadow-purple-700/50 hover:bg-purple-700 transition duration-300 transform hover:scale-105 uppercase tracking-wider border-4 border-purple-300">
                        <span class="text-4xl mb-2">Round 3</span>
                        <span class="text-xl font-light opacity-80">(Password Required)</span>
                    </button>
                </div>

                <button onclick="changeState('start')" 
                    class="mt-16 text-xl text-gray-400 hover:text-indigo-400 transition duration-300">
                    ← Back to Main Screen
                </button>
            </div>
        `;
    }


    function renderPasswordScreen(targetRound) {
        currentRound = targetRound; // Set the currentRound context
        const title = `ROUND ${targetRound} ACCESS (PASSWORD REQUIRED)`;
        const nextState = `round${targetRound}`;

        appEl.innerHTML = `
            <div class="flex flex-col h-full justify-center items-center bg-gray-900 text-white p-8">
                <h2 class="text-5xl font-bold mb-10 text-yellow-400">${title}</h2>
                <input type="password" id="passwordInput" placeholder="Enter Secret Password" 
                    class="text-center text-3xl px-8 py-5 rounded-xl border-4 border-indigo-500 bg-gray-700 text-white focus:outline-none focus:ring-4 focus:ring-purple-500 mb-8 w-96 transition duration-300">
                
                <button onclick="checkPassword('${nextState}')" 
                    class="btn-primary px-12 py-4 bg-indigo-600 text-white text-2xl font-semibold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-300 transform hover:scale-105 border-2 border-indigo-400">
                    Unlock
                </button>
                <p id="errorMsg" class="text-red-400 text-xl mt-6 opacity-0 transition duration-300">Incorrect Password. Access Denied.</p>
                
                <button onclick="changeState('selection')" 
                    class="mt-8 text-xl text-gray-400 hover:text-indigo-400 transition duration-300">
                    ← Back to Round Selection
                </button>
            </div>
        `;
        document.getElementById('passwordInput').focus();
    }

    function checkPassword(targetState) {
        const input = document.getElementById('passwordInput').value;
        const errorEl = document.getElementById('errorMsg');
        if (input === SECRET_PASSWORD) {
            changeState(targetState);
            currentQuestionIndex = 0; // Reset index for the new round
        } else {
            errorEl.style.opacity = '1';
            setTimeout(() => errorEl.style.opacity = '0', 3000);
        }
    }

    function renderRoundScreen() {
        const questions = getCurrentQuestions();
        const qData = questions[currentQuestionIndex];
        const isFinal = currentQuestionIndex === questions.length - 1;

        // isManual is defined in the question data object
        const isManualTiming = qData.isManual;
        
        let roundName = '';
        if (currentRound === 1) roundName = 'RAPID RECALL';
        else if (currentRound === 2) roundName = 'LOGIC & DEDUCTION';
        else if (currentRound === 3) roundName = 'FINAL CODEBREAKER'; // Added Round 3 Title
        
        const roundTitle = `ROUND ${currentRound}: ${roundName}`;

        appEl.innerHTML = `
            <div class="flex flex-col h-full items-center p-8 bg-gray-900 text-white">
                <div class="w-full flex justify-between items-center mb-8 pb-4 border-b-2 border-indigo-700">
                    <h2 class="text-5xl font-extrabold text-indigo-400">${roundTitle}</h2>
                    <div class="text-4xl font-black text-yellow-400 border-4 border-yellow-400 px-6 py-2 rounded-full shadow-lg">
                        Q ${qData.id} / ${questions.length}
                    </div>
                </div>

                <div id="displayArea" class="flex-grow flex flex-col justify-between items-center w-full bg-gray-800 rounded-3xl shadow-2xl p-12 transition duration-500 overflow-auto">
                    
                    <div class="flex flex-col items-center w-full">
                        <h3 class="text-4xl font-bold text-gray-300 mb-12">${qData.title}</h3>
                        
                        <button onclick="startQuestion()" id="startButton"
                            class="btn-primary px-14 py-6 bg-blue-500 text-white text-4xl font-extrabold rounded-xl shadow-2xl shadow-blue-700/50 hover:bg-blue-600 transition duration-300 transform hover:scale-105 border-4 border-blue-300">
                            ${isManualTiming ? 'START VIEWING (MANUAL TIME)' : `START MEMORIZING (${AUTOMATIC_TIME} SECONDS)`}
                        </button>
                    </div>

                    <div id="visualContent" class="hidden w-full h-full flex-grow justify-center items-center p-4">
                        ${generateVisualContent(qData)}
                    </div>
                    
                    <div id="timerDisplay" class="text-9xl font-black text-red-500 mt-10 hidden transition duration-300">5</div>

                    <!-- Manual control will be injected here for manual questions after startQuestion() -->
                </div>
            </div>
        `;
    }

    function generateVisualContent(data) {
        if (data.type === 'circles') {
            return data.colors.map(color => `
                <div class="visual-item w-28 h-28 rounded-full mx-3 transition-colors duration-500" style="background-color: ${color};"></div>
            `).join('');
        }
        if (data.type === 'bottles') {
            return data.colors.map(color => `
                <div class="visual-item w-20 h-48 mx-3 shadow-lg flex flex-col items-center">
                    <div class="w-10 h-10 rounded-t-lg" style="background-color: ${color};"></div>
                    <div class="w-20 h-40 rounded-b-xl" style="background-color: ${color};"></div>
                </div>
            `).join('');
        }
        if (data.type === 'shapes') {
            return data.shapes.map(item => `
                <div class="visual-item flex flex-col items-center mx-6 p-6 bg-gray-900 border-4 border-indigo-500 rounded-xl hover:shadow-indigo-500/50 hover:scale-105 transition duration-300">
                    <div class="text-7xl mb-2" style="color: ${item.color};">
                        ${item.shape === 'Square' ? '◼' : item.shape === 'Triangle' ? '▲' : item.shape === 'Star' ? '★' : '⬤'}
                    </div>
                    <span class="text-2xl font-bold text-gray-300 mt-2">${item.shape}</span>
                </div>
            `).join('');
        }
        
        // --- ROUND 1 Q4: SPOT THE DIFFERENCE (HORIZONTAL LAYOUT) ---
        if (data.type === 'diff') {
            return `
                <div class="flex w-full h-full justify-center space-x-8">
                    <!-- Image A Container -->
                    <div class="flex-1 flex flex-col items-center p-2 bg-gray-900 rounded-xl shadow-inner border-2 border-gray-700 min-w-[45%]">
                        <p class="text-2xl font-bold mb-2 text-indigo-400 uppercase tracking-wider">IMAGE A</p>
                        <!-- Dummy Image Path for Scene A -->
                        <img src="/images/spota.jpg" class="rounded-lg shadow-xl border-4 border-gray-600 w-full h-auto object-contain" alt="Scene A for Spot the Difference"/>
                    </div>
                    <!-- Image B Container -->
                    <div class="flex-1 flex flex-col items-center p-2 bg-gray-900 rounded-xl shadow-inner border-2 border-gray-700 min-w-[45%]">
                        <p class="text-2xl font-bold mb-2 text-indigo-400 uppercase tracking-wider">IMAGE B</p>
                        <!-- Dummy Image Path for Scene B -->
                        <img src="/images/spotb.jpg" class="rounded-lg shadow-xl border-4 border-gray-600 w-full h-auto object-contain" alt="Scene B for Spot the Difference"/>
                    </div>
                </div>
            `;
        }
        if (data.type === 'gap') {
            return `
                <div class="flex flex-wrap justify-center text-4xl font-bold space-x-4">
                    ${data.items.map(item => `
                        <div class="visual-item p-6 m-2 rounded-xl ${item === 'BLANK' ? 'bg-red-800 text-white border-4 border-red-500 shadow-red-700/50' : 'bg-indigo-600 text-white'} min-w-[150px] text-center shadow-lg">
                            ${item === 'BLANK' ? 'GAP' : item}
                        </div>
                    `).join('<div class="text-4xl text-gray-500 self-center">➔</div>')}
                </div>
            `;
        }

        // --- ROUND 2 TYPES (Q6 & Q7: SEPARATE IMAGES) ---
        if (data.type === 'object_recall') {
            // Differentiate Q6 and Q7 visual placeholders
            const imageText = data.id === 6 ? 'OBJECT+RECALL+SCENE+1' : 'OBJECT+RECALL+SCENE+2';
            const borderColor = data.id === 6 ? 'border-green-500' : 'border-purple-500';
            const promptText = data.id === 6 ? 'MEMORIZE ALL OBJECTS, COLORS, AND POSITIONS' : 'FOCUS ON POSITIONS AND DETAILS';

             return `
                <div class="w-full flex flex-col items-center">
                    <p class="text-3xl text-yellow-400 mb-6 font-semibold">${promptText}</p>
                    <!-- Visual Memory Image Placeholder -->
                    <img src="/images/OBJ2.jpg" 
                         class="w-full max-w-4xl rounded-xl border-8 border-solid ${borderColor} shadow-xl h-auto object-contain aspect-video" 
                         alt="Object Recall Visual for Memory Puzzle ${data.id}"
                    />
                </div>
            `;
        }
        if (data.type === 'video') {
            // Using a proper <video> element with a non-loading dummy source path.
             return `
                <div class="w-full flex flex-col items-center text-center">
                    <p class="text-5xl text-red-500 font-extrabold mb-8">COORDINATOR INSTRUCTION: VIDEO ANALYSIS</p>
                    
                    <!-- This VIDEO ELEMENT is a visual placeholder. COORDINATORS MUST PLAY THE ACTUAL VIDEO FILE EXTERNALLY. -->
                    <div class="w-full max-w-4xl aspect-video relative rounded-xl shadow-2xl overflow-hidden border-8 border-red-500 bg-black">
                        <video controls class="w-full h-full object-contain" 
                                poster="https://placehold.co/800x450/990000/ffffff?text=VIDEO+PATH+SET">
                            <!-- DUMMY VIDEO PATH SET HERE -->
                            <source src="/images/THALAP.mp4" type="video/mp4">
                            Your browser does not support the video tag or the dummy video path failed to load.
                        </video>
                    </div>

                    <p class="text-2xl text-indigo-400 mt-8">The video contains the clues required to answer the question.</p>
                </div>
            `;
        }
        // --- Q9 & Q10: SINGLE IMAGE SCENARIO (Removed Grid) ---
        if (data.type === 'killer_scenario') {
            const imageText = data.id === 9 ? 'FIND+THE+' : 'FIND+THE+';
            const borderColor = data.id === 9 ? 'border-red-500' : 'border-blue-500';
            const clueText = data.panels.map(p => p.split(': ')[1]).join(' | ');

            return `
                <div class="w-full flex flex-col items-center text-center">
                    <p class="text-3xl text-yellow-400 mb-6 font-semibold">ANALYZE THE SINGLE SCENE IMAGE CAREFULLY</p>
                    <!-- Single Image Placeholder for  Scenario -->
                    <img src="/images/OBJ3.jpg" 
                         class="w-full max-w-6xl rounded-xl border-8 border-solid ${borderColor} shadow-xl h-auto object-contain" 
                         alt="Single Scene for Killer Scenario ${data.id}"
                    />
                    <div class="mt-8 text-2xl font-medium text-gray-300 px-4 py-3 bg-gray-700 rounded-lg max-w-4xl">
                        **Clues to Focus On:** ${clueText}
                    </div>
                </div>
            `;
        }
        
        // --- ROUND 3 NEW TYPES ---
        if (data.type === 'code_breaker') {
            return `
                <div class="flex flex-col items-center w-full">
                    <p class="text-4xl font-extrabold text-yellow-400 mb-8">CODE SEQUENCE TO MEMORIZE (5 DIGITS)</p>
                    <div class="flex space-x-6">
                        ${data.code_parts.map((part, index) => `
                            <div class="visual-item w-32 h-32 rounded-lg p-3 flex flex-col items-center justify-center border-4 border-white shadow-xl hover:scale-105 transition duration-300" style="background-color: ${part.color};">
                                <span class="text-xl font-bold text-black opacity-80 mb-1">POS ${index + 1}</span>
                                <span class="text-lg font-semibold text-white bg-black/30 p-1 rounded">${part.hint}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        if (data.type === 'reverse_deduction') {
             return `
                <div class="w-full flex flex-col items-center">
                    <p class="text-4xl text-yellow-400 mb-8 font-semibold">REVERSE ORDER THE ITEMS</p>
                    <div class="flex flex-wrap justify-center text-5xl font-bold space-x-6">
                        ${data.items.map(item => `
                            <div class="visual-item p-6 m-2 rounded-xl bg-purple-600 text-white min-w-[200px] text-center shadow-lg border-4 border-purple-300 hover:scale-105 transition duration-300">
                                ${item}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        return '';
    }
    
    // --- Flow Control ---

    function startQuestion() {
        document.getElementById('startButton').classList.add('hidden');
        const visualEl = document.getElementById('visualContent');
        const timerEl = document.getElementById('timerDisplay');
        const qData = getCurrentQuestions()[currentQuestionIndex]; 
        const displayArea = document.getElementById('displayArea');

        // Show the visual content area
        visualEl.classList.remove('hidden');
        visualEl.classList.add('flex');
        
        if (!qData.isManual) {
            // --- Standard Timed Questions (R1: Q1, Q2, Q3) ---
            let timeLeft = AUTOMATIC_TIME;
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('hidden');

            timerInstance = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                if (timeLeft < 0) {
                    clearInterval(timerInstance);
                    timerComplete(); // Auto-transition
                }
            }, 1000);
        } else {
            // --- Manual Timing Questions (R1: Q4, Q5 | R2: All | R3: All) ---
            timerEl.classList.add('hidden');
            
            // Add the manual time-up button below the visual content container
            const manualControlHtml = `
                <div id="manualControl" class="mt-8 text-center w-full">
                    <p class="text-3xl font-bold text-yellow-400 mb-4">COORDINATOR: Click "TIME UP" when viewing/video time is over.</p>
                    <button onclick="manualTimeUp()" 
                        class="btn-primary px-12 py-5 bg-red-600 text-white text-3xl font-extrabold rounded-xl shadow-2xl shadow-red-700/50 hover:bg-red-700 transition duration-300 transform hover:scale-105 border-4 border-red-300">
                        TIME UP (STOP VIEWING)
                    </button>
                </div>
            `;
            // Append the manual control to the display area (using the main div for placement)
            document.getElementById('displayArea').insertAdjacentHTML('beforeend', manualControlHtml);
        }
    }

    function manualTimeUp() {
        // Remove the manual control button
        const manualControlEl = document.getElementById('manualControl');
        if (manualControlEl) {
            manualControlEl.remove();
        }
        timerComplete();
    }

    function timerComplete() {
        playTimeUp();
        
        // Hide the visual content and timer
        document.getElementById('visualContent').classList.add('hidden');
        document.getElementById('visualContent').classList.remove('flex');
        document.getElementById('timerDisplay').classList.add('hidden');
        
        const displayArea = document.getElementById('displayArea');
        displayArea.classList.remove('bg-gray-800');
        displayArea.classList.add('bg-gray-900'); 
        
        displayArea.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full w-full">
                <h2 class="text-9xl font-black text-red-500 mb-6 time-up-message">TIME UP!</h2>
                <p class="text-4xl text-yellow-400 mb-12 font-semibold">COORDINATORS: Teams are now writing answers.</p>
                
                <button onclick="showQuestionPrompt()" 
                    class="btn-primary px-10 py-5 bg-red-600 text-white text-3xl font-bold rounded-xl shadow-2xl shadow-red-700/50 hover:bg-red-700 transition duration-300 transform hover:scale-105 border-4 border-red-300">
                    ANSWERS COLLECTED / ASK QUESTION
                </button>
            </div>
        `;
    }

    function showQuestionPrompt() {
        const displayArea = document.getElementById('displayArea');
        displayArea.classList.remove('bg-gray-900');
        displayArea.classList.add('bg-gray-800'); 
        
        const questions = getCurrentQuestions();
        const qData = questions[currentQuestionIndex];
        const isFinal = currentQuestionIndex === questions.length - 1;

        let nextActionText = 'CONTINUE TO NEXT QUESTION';
        if (isFinal) {
            if (currentRound === 1) {
                nextActionText = 'PROCEED TO ROUND 2 ACCESS';
            } else if (currentRound === 2) {
                nextActionText = 'PROCEED TO ROUND 3 ACCESS';
            } else {
                nextActionText = 'END EVENT';
            }
        }
        
        displayArea.innerHTML = `
            <div class="w-full text-center p-4">
                <h3 class="text-5xl font-bold text-indigo-400 mb-8">${qData.title}</h3>
                <h4 class="text-4xl font-extrabold text-yellow-400 mb-6">THE QUESTION IS:</h4>
                <p class="text-3xl font-semibold text-gray-100 mb-10 p-6 bg-gray-700 rounded-xl max-w-4xl mx-auto border-l-8 border-yellow-500">${qData.prompt}</p>
                
                <button onclick="nextStep()" 
                    class="btn-primary px-10 py-5 bg-purple-600 text-white text-3xl font-bold rounded-xl shadow-2xl shadow-purple-700/50 hover:bg-purple-700 transition duration-300 transform hover:scale-105 border-4 border-purple-300">
                    ${nextActionText}
                </button>
            </div>
        `;
    }

    function nextStep() {
        const questions = getCurrentQuestions();
        if (currentQuestionIndex < questions.length - 1) {
            // Next question in current round
            currentQuestionIndex++;
            renderRoundScreen();
        } else if (currentRound === 1) {
            // End of Round 1, transition to Round 2 password screen
            currentRound = 2;
            changeState('password2');
        } else if (currentRound === 2) {
            // End of Round 2, transition to Round 3 password screen
            currentRound = 3;
            changeState('password3');
        } else if (currentRound === 3) {
            // End of Round 3
            changeState('end');
        }
    }

    function renderEndScreen() {
        appEl.innerHTML = `
            <div class="flex flex-col h-full justify-center items-center text-white bg-indigo-900 p-8">
                <h2 class="text-7xl font-extrabold mb-8 text-yellow-400">EVENT COMPLETE!</h2>
                <p class="text-4xl font-light mb-12 text-gray-300">Thank you for participating in Mind Master.</p>
                <p class="text-2xl mt-8 text-indigo-400">Coordinators, please collect final scores. Stand by for the winner announcement.</p>
                
                <button onclick="changeState('start')" 
                    class="mt-12 btn-primary px-8 py-3 bg-gray-600 text-white text-xl font-bold rounded-lg shadow-xl hover:bg-gray-700 transition duration-300 transform hover:scale-105 border-2 border-gray-400">
                    Restart Event
                </button>
            </div>
        `;
    }

    // --- Core Renderer ---

    function changeState(newState) {
        currentState = newState;
        renderApp();
    }

    function renderApp() {
        // Ensure Tone is initialized when the user clicks 'Start Event' for the first time
        if (!synth) initTone(); 
        
        switch (currentState) {
            case 'start':
                renderStartScreen();
                break;
            case 'selection': // New state for round selection
                renderRoundSelectionScreen();
                break;
            case 'password1': // NEW: Round 1 requires password
                renderPasswordScreen(1);
                break;
            case 'password2':
                renderPasswordScreen(2);
                break;
            case 'password3':
                renderPasswordScreen(3);
                break;
            case 'round1':
                currentRound = 1; 
                renderRoundScreen();
                break;
            case 'round2':
                currentRound = 2;
                renderRoundScreen();
                break;
            case 'round3':
                currentRound = 3;
                renderRoundScreen();
                break;
            case 'end':
                renderEndScreen();
                break;
            default:
                renderStartScreen();
        }
    }

    // --- Initialization ---
    window.onload = () => {
        appEl = document.getElementById('app');
        initTone();
        renderApp();
    };

</script>

</body>
</html>
